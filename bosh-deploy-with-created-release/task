#!/bin/bash -eux

# shellcheck disable=SC1091
source cf-deployment-concourse-tasks/shared-functions

optional_submodule_bump() {
  set +x
    if [ -z "${BUMP_SUBMODULE}" ] && ! [ -z "${SUBMODULE_BRANCH}" ]; then
      echo "SUBMODULE_BRANCH must not be set without a path set for BUMP_SUBMODULE"
      exit 1
    fi

    if [ -z "${SUBMODULE_BRANCH}" ] && ! [ -z "${BUMP_SUBMODULE}" ]; then
      echo "BUMP_SUBMODULE must not be set without a ref set for SUBMODULE_BRANCH"
      exit 1
    fi
  set -x

  if ! [ -z "${BUMP_SUBMODULE}" ]; then
    pushd "release/${BUMP_SUBMODULE}"
      git checkout "${SUBMODULE_BRANCH}"
      git pull
    popd
  fi
}

main() {
  local root_dir
  root_dir="${1}"

  check_input_params
  optional_submodule_bump
  setup_bosh_env_vars

  local release_name
  local release_version
  if [[ -n ${RELEASE_NAME_OF_TARBALL} ]]; then
    if [[ ! -r "${root_dir}/release_tarball_name/name" ]]; then
      echo "When providing 'RELEASE_NAME_OF_TARBALL', 'release_tarball_name' must be given."
      exit 1
    fi
    if [[ -z ${RELEASE_VERSION_OF_TARBALL} ]]; then
      echo "When providing 'RELEASE_NAME_OF_TARBALL', 'RELEASE_VERSION_OF_TARBALL' must be also given."
      exit 1
    fi
    release_name="${RELEASE_NAME_OF_TARBALL}"
    release_version="${RELEASE_VERSION_OF_TARBALL}"
  else
    release_name="$(yq -r '.name' release/config/final.yml)"
    if [[ "${release_name}" == "null" ]]; then
      release_name="$(yq -r '.final_name' release/config/final.yml)"
    fi
    if [[ "${release_name}" == "null" ]]; then
      echo "Expected non-empty 'name' or 'final_name' in release/config/final.yml"
      exit 1
    fi
  fi

  if [[ -r "${root_dir}/release_tarball_name/name" ]]; then
    bosh_interpolate "${root_dir}" "${release_name}" "${release_version}" "$(cat ${root_dir}/release_tarball_name/name)"
  else
    bosh_interpolate "${root_dir}" "${release_name}"
  fi

  if [ "$REGENERATE_CREDENTIALS" == true ]; then
    remove_credentials_from_credhub
  fi
  upload_stemcells
  # shellcheck disable=SC2086
  bosh_deploy ${BOSH_DEPLOY_ARGS}
}

main "${PWD}"
